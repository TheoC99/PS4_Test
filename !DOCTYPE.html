<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ESP32 RC Controller + PS4</title>
  <style>
    body { text-align: center; font-family: sans-serif; }
    button { width: 100px; height: 100px; font-size: 30px; margin: 5px; border-radius: 15px; }
    .row { display: flex; justify-content: center; margin: 10px; }
  </style>
</head>
<body>
  <h2>ESP32 RC Controller + PS4</h2>
  <div class="row">
    <button id="btnForward">↑</button>
  </div>
  <div class="row">
    <button id="btnLeft">←</button>
    <button id="btnStop">■</button>
    <button id="btnRight">→</button>
  </div>
  <div class="row">
    <button id="btnBackward">↓</button>
  </div>
  <div class="row">
    <button id="btnConnect">Verbind ESP32</button>
  </div>

<script>
let bleCharacteristic;

async function connectBLE() {
  try {
    const device = await navigator.bluetooth.requestDevice({
      filters: [{ name: 'ESP32_RC_BLE' }],
      optionalServices: ['6e400001-b5a3-f393-e0a9-e50e24dcca9e']
    });
    const server = await device.gatt.connect();
    const service = await server.getPrimaryService('6e400001-b5a3-f393-e0a9-e50e24dcca9e');
    bleCharacteristic = await service.getCharacteristic('6e400003-b5a3-f393-e0a9-e50e24dcca9e');
    alert("Verbonden met ESP32!");
  } catch(error) {
    alert("Fout bij verbinden: " + error);
  }
}

async function sendCmd(cmd) {
  if (!bleCharacteristic) await connectBLE();
  const encoder = new TextEncoder();
  await bleCharacteristic.writeValue(encoder.encode(cmd));
}

// Buttons events
const btnForward = document.getElementById("btnForward");
const btnBackward = document.getElementById("btnBackward");
const btnLeft = document.getElementById("btnLeft");
const btnRight = document.getElementById("btnRight");
const btnStop = document.getElementById("btnStop");
const btnConnect = document.getElementById("btnConnect");

function addHoldEvents(button, cmd) {
  button.addEventListener("mousedown", () => sendCmd(cmd));
  button.addEventListener("mouseup", () => sendCmd("S"));
  button.addEventListener("touchstart", () => sendCmd(cmd));
  button.addEventListener("touchend", () => sendCmd("S"));
}

addHoldEvents(btnForward, "F");
addHoldEvents(btnBackward, "B");
addHoldEvents(btnLeft, "L");
addHoldEvents(btnRight, "R");

btnStop.addEventListener("click", () => sendCmd("S"));
btnConnect.addEventListener("click", () => connectBLE());

// Keyboard controls
let keysPressed = {};
document.addEventListener("keydown", (event) => {
  if (keysPressed[event.key]) return; 
  keysPressed[event.key] = true;
  switch(event.key.toLowerCase()) {
    case "w": sendCmd("F"); break;
    case "a": sendCmd("L"); break;
    case "s": sendCmd("B"); break;
    case "d": sendCmd("R"); break;
  }
});
document.addEventListener("keyup", (event) => {
  keysPressed[event.key] = false;
  switch(event.key.toLowerCase()) {
    case "w":
    case "a":
    case "s":
    case "d":
      sendCmd("S");
      break;
  }
});

// PS4 Controller support
function pollGamepad() {
  const gp = navigator.getGamepads()[0]; // eerste gamepad
  if (gp) {
    let cmd = "S"; // standaard stop
    // Joystick vertical: -1 = omhoog, 1 = omlaag
    if (gp.axes[1] < -0.5) cmd = "F";
    else if (gp.axes[1] > 0.5) cmd = "B";
    
    // Joystick horizontal: -1 = links, 1 = rechts
    if (gp.axes[0] < -0.5) cmd = "L";
    else if (gp.axes[0] > 0.5) cmd = "R";
    
    // Alternatief: buttons (bijv. X = vooruit)
    if (gp.buttons[0].pressed) cmd = "F"; // X knop
    if (gp.buttons[1].pressed) cmd = "B"; // Cirkel knop
    if (gp.buttons[2].pressed) cmd = "L"; // Vierkant
    if (gp.buttons[3].pressed) cmd = "R"; // Driehoek

    sendCmd(cmd);
  }
  requestAnimationFrame(pollGamepad);
}
window.addEventListener("gamepadconnected", (e) => {
  console.log("Gamepad verbonden:", e.gamepad);
  requestAnimationFrame(pollGamepad);
});
</script>
</body>
</html>
